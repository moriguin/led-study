# Servo2モジュールの基本設定コードについて

## 質問
```cpp
// === 基本設定（変更不要） ===
Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver(0x40, Wire1);
#define SERVOMIN  102    // 0度の位置
#define SERVOMAX  512    // 180度の位置
#define SERVO_FREQ 50     // サーボの周波数
```
このコードは何？

## 回答

このコードは**Servo2モジュールを制御するための基本設定**です。

### **1. `Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver(0x40, Wire1);`**

これは**Servo2モジュールとの通信を管理するオブジェクト**を作成しています。

```cpp
Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver(0x40, Wire1);
                        ↑                              ↑     ↑
                   オブジェクト名                   I2Cアドレス  通信ポート
```

- **`pwm`**: このオブジェクトを通じてServo2を操作
- **`0x40`**: Servo2モジュールの住所（I2Cアドレス）
- **`Wire1`**: M5Core2のI2C通信路（GPIO32/33、論理的にPort A相当）

**例え**：電話で言うと、`0x40`が電話番号、`Wire1`が電話回線

### **2. `#define SERVOMIN 102`**

サーボが**0度の位置**にいる時のPWM値です。

```
PWM値とは？
0 -------- 102 ------------ 512 ------------ 4095
          0度              180度            最大値
```

- サーボは**パルス幅**で角度を決める
- **102**という値 = 約0.5ミリ秒のパルス幅 = 0度

### **3. `#define SERVOMAX 512`**

サーボが**180度の位置**にいる時のPWM値です。

- **512**という値 = 約2.5ミリ秒のパルス幅 = 180度

### **4. `#define SERVO_FREQ 50`**

サーボに送る信号の**周波数**（1秒間に何回信号を送るか）です。

- **50Hz** = 1秒間に50回信号を送る
- **20ミリ秒**ごとに1回信号を送る
- ほとんどのサーボは50Hzで動作

### **なぜこれらの値？**

サーボモーターの一般的な規格：
- **50Hz**の周波数で動作
- **0.5～2.5ミリ秒**のパルス幅で0～180度を制御

```
実際の動作イメージ：
        ┌─┐              ┌─┐              ┌─┐
        │ │              │ │              │ │
────────┘ └──────────────┘ └──────────────┘ └──────
        ↑                ↑                ↑
     0.5ms(0度)       1.5ms(90度)      2.5ms(180度)

     <------- 20ms ------->（50Hzの周期）
```

### **まとめ**

これらの設定は：
1. **どのモジュールと通信するか**（アドレス0x40）
2. **どの通信路を使うか**（Wire1）
3. **サーボの角度とPWM値の対応**（102～512）
4. **信号の送信頻度**（50Hz）

を定義していて、**ほとんどのサーボで共通**なので「変更不要」としています。

## 追加質問：これらの値はどこから来たのか？

### **質問**
0x40, Wire1 っていうのはどこからでてきたの？あと、0度が102とか、周波数が50とか。

### **回答**

これらの値の**出所**を詳しく説明します。

#### **1. `0x40`（I2Cアドレス）の出所**

**Servo2モジュールの仕様書/データシート**に記載されています。

```
出所：M5Stack Servo2モジュールの公式仕様
- PCA9685チップのデフォルトアドレス = 0x40
- DIPスイッチで0x40～0x47まで変更可能
```

**なぜ0x40？**
- PCA9685チップの製造元（NXP社）が決めたデフォルト値
- 16進数表記（0x40 = 10進数で64）

#### **2. `Wire1`の出所**

**M5Core2のハードウェア仕様**から来ています。

```
M5Core2のI2Cポート：
- Wire  = 内部I2C（GPIO21/22）- タッチパネルなどが使用
- Wire1 = Port A（GPIO32/33）- 外部モジュール用 ← これを使う！
```

**なぜWire1？**
- GPIO32/33は`Wire1`として定義されている
- M5Core2底面のM-Bus経由でも同じGPIO32/33にアクセス
- 側面Port A（赤色）と同じ信号線を使用

#### **3. `SERVOMIN = 102`と`SERVOMAX = 512`の出所**

**サーボモーターの一般的な規格**と**実測値**から決まっています。

##### **理論値の計算**

```
PWM周期 = 1秒 ÷ 50Hz = 20ミリ秒
12ビット分解能 = 4096段階

理論計算：
0.5ms ÷ 20ms × 4096 = 102.4 → 102（0度）
2.5ms ÷ 20ms × 4096 = 512（180度）
```

##### **実際の出所**

1. **サーボメーカーの仕様書**
   - 例：SG90サーボの仕様書に「0.5ms～2.5ms」と記載

2. **Adafruitのサンプルコード**
   ```cpp
   // Adafruit公式のサンプルコードより
   #define SERVOMIN  150 // 実測調整値
   #define SERVOMAX  600 // 実測調整値
   ```

3. **M5Stackの公式サンプル**
   ```cpp
   // M5Stack Servo2の例より
   #define SERVOMIN  102
   #define SERVOMAX  512
   ```

#### **4. `SERVO_FREQ = 50`の出所**

**サーボモーターの業界標準**です。

```
歴史的経緯：
1. 1960年代：ラジコン用サーボが開発される
2. 当時のラジコン送信機の仕様：50Hz（アナログ時代の標準）
3. 現在も互換性のため50Hzが標準
```

**仕様書での記載例**：
- SG90サーボ：「PWM Period: 20ms (50Hz)」
- MG996Rサーボ：「Control System: +Pulse Width Control 1500usec Neutral」

### **まとめ：値の出所**

| 値 | 出所 | 理由 |
|---|---|---|
| 0x40 | Servo2モジュールの仕様書 | PCA9685のデフォルトアドレス |
| Wire1 | M5Core2の仕様書 | GPIO32/33がWire1として定義（M-Bus経由でアクセス） |
| 102, 512 | サーボの規格＋実測値 | 0.5ms/2.5msをPWM値に変換 |
| 50Hz | サーボ業界標準 | ラジコンサーボの歴史的標準 |

これらの値は**メーカーの仕様書**や**業界標準**から来ているため、通常は変更する必要がありません。

### **実際に確認する方法**

1. **M5Stack公式ドキュメント**
   - https://docs.m5stack.com/en/module/servo2

2. **PCA9685データシート**
   - NXP社の公式データシート

3. **使用するサーボの仕様書**
   - 各サーボメーカーのデータシート

これらの文書に、今回使用している値が記載されています。