# サーボが動かない時のトラブルシューティング

## 問題
M5StackとServo2 Moduleでサーボを動かそうとしたが、サーボモーターが動かない。

## 診断プロセス

### 1. I2C通信の確認
シリアルモニターの出力を確認：
```
I2C Scanning...
Found: x34
Found: x38
Found: x40  ← Servo2モジュール（PCA9685）が検出されている
Found: x70
```

**結果**: I2C通信は正常に動作していた

### 2. PWM信号の送信確認
```
CH0: tested
CH1: tested
CH2: tested
CH3: tested
Active CH: 0,1,2,3と切り替わる
```

**結果**: PWM信号も正常に送信されていた

### 3. 電源供給の確認
- Servo2モジュールに外部電源を接続済み
- サーボは起動時に少し「ピクッ」と動いた

**結果**: 電源供給も問題なし

## 原因

**サーボモーターとServo2モジュールの接続不良（差し具合が悪かった）**

## 解決方法

サーボのコネクタをしっかりと差し直した

## 学んだこと

### 電子工作のトラブルシューティング手順

1. **ソフトウェアの確認**
   - I2C通信が正常か（デバイスが検出されているか）
   - PWM信号が送信されているか
   - シリアルモニターでログを確認

2. **電源供給の確認**
   - 外部電源が接続されているか
   - 電圧が適切か（サーボの仕様を確認）
   - 起動時の「ピクッ」という動きは電源が来ている証拠

3. **物理的な接続の確認** ← **今回の原因**
   - コネクタがしっかり差さっているか
   - ピンの向きが正しいか
   - ケーブルが断線していないか
   - 接点が汚れていないか

### コードの改善点

当初のコードでは変化が早すぎて、サーボが追従できない可能性があった。
以下の改善を行った：

```cpp
// 改善前：変化が早い
for(int pulse = 102; pulse < 512; pulse += 50) {
  pwm.setPWM(ch, 0, pulse);
  delay(100);  // 100ms間隔
}

// 改善後：ゆっくり大きく動かす
int minPulse = 150;   // 最小位置
int maxPulse = 450;   // 最大位置
int midPulse = 300;   // 中間位置

pwm.setPWM(ch, 0, minPulse);
delay(2000);  // 2秒待機
pwm.setPWM(ch, 0, maxPulse);
delay(2000);  // 2秒待機
```

## チェックリスト：サーボが動かない時

- [ ] I2C通信は正常か（0x40が検出されているか）
- [ ] 外部電源は接続されているか
- [ ] サーボのコネクタはしっかり差さっているか ← **最重要**
- [ ] サーボは正しいチャンネル（CH0～CH15）に接続されているか
- [ ] PWM値の範囲は適切か（一般的に150～450）
- [ ] 待機時間は十分か（最低1～2秒）

## コードの料理的な例え

**問題のあったコード**：
- フライパンを1秒ごとに「強火→弱火→強火→弱火」と切り替えるようなもの
- 料理（サーボ）が温度変化についていけない

**改善したコード**：
- 「強火で2分→弱火で2分→中火で2分」とゆっくり明確に切り替える
- 料理（サーボ）が確実に状態を変えられる

## 参考ファイル

- 診断用コード: `src/test_servo.cpp`
- 改善内容: `test_servo.cpp:70-116`
